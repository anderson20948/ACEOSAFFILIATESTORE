<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aceos Admin - Pending Approvals</title>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">
    <link rel="stylesheet" href="css/font-awesome.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- For product card styles maybe, or just inline -->
    <style>
        .product-card {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .product-title {
            font-weight: bold;
            font-size: 1.1em;
        }

        .product-price {
            color: #28a745;
            font-weight: bold;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Enhanced Analytics Styles */
        .health-overview {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .health-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .health-metric {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .health-metric .value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }

        .health-metric .label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .metric-good { color: #28a745 !important; }
        .metric-warning { color: #ffc107 !important; }
        .metric-critical { color: #dc3545 !important; }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }

        .performance-details {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .performance-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .performance-item.server { border-left-color: #28a745; }
        .performance-item.database { border-left-color: #ffc107; }
        .performance-item.api { border-left-color: #dc3545; }

        .performance-item h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .performance-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .alert-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid;
        }

        .alert-item.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }

        .alert-item.critical {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            transition: width 0.3s ease;
        }

        .progress-fill.warning { background: linear-gradient(90deg, #ffc107, #fd7e14); }
        .progress-fill.critical { background: linear-gradient(90deg, #dc3545, #fd7e14); }

        /* Admin Dashboard Enhancements */
        .admin-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
            overflow-x: auto;
        }

        .admin-tab-button {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .admin-tab-button.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .admin-tab-button:hover {
            color: #007bff;
        }

        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .applications-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .application-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            border-left: 4px solid #007bff;
        }

        .application-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .application-actions {
            display: flex;
            gap: 10px;
        }

        .btn-approve {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-reject {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        .user-activity-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-activity-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .user-activity-table th,
        .user-activity-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .user-activity-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .activity-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .type-login { background: #d4edda; color: #155724; }
        .type-logout { background: #f8d7da; color: #721c24; }
        .type-page_view { background: #d1ecf1; color: #0c5460; }
        .type-campaign_create { background: #fff3cd; color: #856404; }

        .system-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .overview-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .overview-card h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .metric-item {
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .notification-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .notification-item.unread {
            border-left-color: #ffc107;
            background: #fffbf0;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .notification-title {
            font-weight: 600;
            color: #333;
        }

        .notification-time {
            font-size: 12px;
            color: #666;
        }

        .notification-message {
            color: #555;
            font-size: 14px;
        }

        .priority-high { border-left-color: #dc3545; }
        .priority-critical { border-left-color: #dc3545; background: #f8d7da; }

        .email-logs-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .email-logs-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .email-logs-table th,
        .email-logs-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .email-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-sent { background: #d4edda; color: #155724; }
        .status-failed { background: #f8d7da; color: #721c24; }
        .status-pending { background: #fff3cd; color: #856404; }

        /* Real-time indicators */
        .realtime-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            0% { transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* Role badges */
        .role-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .role-admin {
            background: #dc3545;
            color: white;
        }

        .role-affiliate {
            background: #007bff;
            color: white;
        }

        .role-user {
            background: #28a745;
            color: white;
        }
    </style>
</head>

<body class="dashboard-body">

    <!-- Sidebar -->
    <aside id="dashboard-sidebar">
        <div class="sidebar-header">
            <a href="home.html" class="sidebar-brand">Aceos Admin</a>
        </div>
        <ul class="sidebar-nav">
            <li><a href="dashboard-products.html"><i class="fa fa-th-large"></i> User Dashboard</a></li>
            <li><a href="#" onclick="showSection('analytics')" id="link-analytics"><i class="fa fa-bar-chart"></i>
                    Analytics</a></li>
            <li><a href="#" onclick="showSection('pending')" id="link-pending" class="active"><i
                        class="fa fa-clock-o"></i> Pending Approvals</a></li>
            <li><a href="#" onclick="showSection('payments')" id="link-payments"><i class="fa fa-paypal"></i>
                    Payments</a></li>
            <li><a href="#" onclick="showSection('users')" id="link-users"><i class="fa fa-users"></i> Users</a></li>
            <li><a href="#" onclick="showSection('system')" id="link-system"><i class="fa fa-cog"></i> System
                    Management</a></li>
        </ul>
    </aside>

    <!-- Main Content -->
    <div id="dashboard-content">
        <!-- Topbar -->
        <header class="dashboard-topbar">
            <h2>Admin Dashboard</h2>
            <div class="user-menu">
                <span id="admin-name">Admin</span>
                <div class="user-avatar"></div>
                <button onclick="logout()" class="btn-danger"
                    style="margin-left: 10px; font-size: 12px;">Logout</button>
            </div>
        </header>

        <!-- Main View -->
        <main class="dashboard-main">
            <!-- Admin Navigation Tabs -->
            <div class="admin-tabs">
                <button class="admin-tab-button active" onclick="showAdminTab('overview')">System Overview</button>
                <button class="admin-tab-button" onclick="showAdminTab('applications')">Advertising Applications</button>
                <button class="admin-tab-button" onclick="showAdminTab('users')">User Management</button>
                <button class="admin-tab-button" onclick="showAdminTab('activities')">User Activities</button>
                <button class="admin-tab-button" onclick="showAdminTab('notifications')">Notifications</button>
                <button class="admin-tab-button" onclick="showAdminTab('emails')">Email Logs</button>
                <button class="admin-tab-button" onclick="showAdminTab('ads')">Ad Management</button>
                <button class="admin-tab-button" onclick="showAdminTab('payments')">Payment Services</button>
            </div>

            <!-- System Overview Section -->
            <div id="overview" class="admin-section active">
                <div class="system-overview">
                    <div class="overview-card">
                        <h3><i class="fa fa-users"></i> User Statistics</h3>
                        <div class="metric-grid">
                            <div class="metric-item">
                                <div class="metric-value" id="totalUsers">0</div>
                                <div class="metric-label">Total Users</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="activeUsers">0</div>
                                <div class="metric-label">Active Today</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="newUsers">0</div>
                                <div class="metric-label">New This Week</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="advertisingUsers">0</div>
                                <div class="metric-label">Advertising Users</div>
                            </div>
                        </div>
                    </div>

                    <div class="overview-card">
                        <h3><i class="fa fa-shopping-cart"></i> Commerce & Revenue</h3>
                        <div class="metric-grid">
                            <div class="metric-item">
                                <div class="metric-value" id="totalRevenue">$0</div>
                                <div class="metric-label">Total Revenue</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="monthlyRevenue">$0</div>
                                <div class="metric-label">This Month</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="pendingCommissions">$0</div>
                                <div class="metric-label">Pending Commissions</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="totalClicks">0</div>
                                <div class="metric-label">Total Clicks</div>
                            </div>
                        </div>
                    </div>

                    <div class="overview-card">
                        <h3><i class="fa fa-bullhorn"></i> Advertising Performance</h3>
                        <div class="metric-grid">
                            <div class="metric-item">
                                <div class="metric-value" id="activeCampaigns">0</div>
                                <div class="metric-label">Active Campaigns</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="pendingApplications">0</div>
                                <div class="metric-label">Pending Applications</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="adImpressions">0</div>
                                <div class="metric-label">Ad Impressions</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="adRevenue">$0</div>
                                <div class="metric-label">Ad Revenue</div>
                            </div>
                        </div>
                    </div>

                    <div class="overview-card">
                        <h3><i class="fa fa-server"></i> System Health</h3>
                        <div class="metric-grid">
                            <div class="metric-item">
                                <div class="metric-value" id="systemUptime">100%</div>
                                <div class="metric-label">System Uptime</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="activeConnections">0</div>
                                <div class="metric-label">Active Connections</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="pendingTasks">0</div>
                                <div class="metric-label">Pending Tasks</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="errorRate">0%</div>
                                <div class="metric-label">Error Rate</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advertising Applications Section -->
            <div id="applications" class="admin-section">
                <div class="applications-list" id="applicationsList">
                    <!-- Applications will be loaded here -->
                </div>
            </div>

            <!-- User Management Section -->
            <div id="users" class="admin-section">
                <div class="overview-card">
                    <h3><i class="fa fa-users"></i> User Management</h3>
                    <div id="usersList">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- User Activities Section -->
            <div id="activities" class="admin-section">
                <div class="user-activity-table">
                    <table id="activitiesTable">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Activity Type</th>
                                <th>Details</th>
                                <th>IP Address</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="activitiesBody">
                            <!-- Activities will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Notifications Section -->
            <div id="notifications" class="admin-section">
                <div id="notificationsList">
                    <!-- Notifications will be loaded here -->
                </div>
            </div>

            <!-- Email Logs Section -->
            <div id="emails" class="admin-section">
                <div class="email-logs-table">
                    <table id="emailsTable">
                        <thead>
                            <tr>
                                <th>Recipient</th>
                                <th>Subject</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Sent At</th>
                            </tr>
                        </thead>
                        <tbody id="emailsBody">
                            <!-- Email logs will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Ad Management Section -->
            <div id="ads" class="admin-section">
                <div class="overview-card">
                    <h3><i class="fa fa-bullhorn"></i> Ad Management</h3>
                    <div id="adsList">
                        <!-- Ads will be loaded here -->
                    </div>
                    <button class="btn-success" style="margin-top: 15px;" onclick="createNewAd()">
                        <i class="fa fa-plus"></i> Create New Ad
                    </button>
                </div>
            </div>

            <!-- Payment Services Section -->
            <div id="payments" class="admin-section">
                <div class="overview-card">
                    <h3><i class="fa fa-paypal"></i> Payment Services</h3>
                    <div id="paymentsContent">
                        <!-- Payment services content will be loaded here -->
                    </div>
                </div>
            </div>
            <!-- Analytics Section -->
            <div id="section-analytics" class="admin-section" style="display: none;">
                <h1 class="page-title">System Analytics</h1>

                <!-- Real-time System Health -->
                <div class="health-overview" style="margin-bottom: 30px;">
                    <h3 style="color: #333; margin-bottom: 15px;">System Health <span id="health-status" style="float: right; padding: 5px 10px; border-radius: 4px; font-size: 12px;"></span></h3>
                    <div class="health-metrics" id="health-metrics">
                        <!-- Health metrics loaded here -->
                    </div>
                </div>

                <!-- Main Stats Grid -->
                <div class="stats-grid" id="stats-container">
                    <!-- Stats loaded here -->
                </div>

                <!-- Performance Charts -->
                <div class="charts-section" style="margin-top: 30px;">
                    <div class="chart-container">
                        <h3>Revenue Trend (Last 7 Days)</h3>
                        <canvas id="revenueChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>User Growth (Last 30 Days)</h3>
                        <canvas id="userGrowthChart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- System Performance Details -->
                <div class="performance-details" style="margin-top: 30px;">
                    <h3>System Performance</h3>
                    <div class="performance-grid" id="performance-details">
                        <!-- Detailed performance metrics -->
                    </div>
                </div>

                <h2 style="margin-top: 30px;">Recent Activity</h2>
                <div class="activity-log" id="activity-log">
                    <p>Loading activity logs...</p>
                </div>

                <!-- System Alerts -->
                <div id="system-alerts" style="margin-top: 30px;">
                    <h3>System Alerts</h3>
                    <div id="alerts-container"></div>
                </div>
            </div>

            <!-- Pending Section -->
            <div id="section-pending" class="admin-section">
                <h1 class="page-title">Pending Products</h1>
                <p class="page-subtitle">Review and approve products uploaded by affiliates.</p>
                <div id="pending-list" class="card-grid" style="display: block;">
                    <p>Loading pending products...</p>
                </div>
            </div>

            <!-- Payments Section -->
            <div id="section-payments" class="admin-section" style="display: none;">
                <h1 class="page-title">Payment History</h1>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>User</th>
                                <th>Product</th>
                                <th>Amount</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="payment-list"></tbody>
                    </table>
                </div>
            </div>

            <!-- Users Section -->
            <div id="section-users" class="admin-section" style="display: none;">
                <h1 class="page-title">Registered Users</h1>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Joined</th>
                            </tr>
                        </thead>
                        <tbody id="user-list"></tbody>
                    </table>
                </div>
                <!-- System Management Section -->
                <div id="section-system" class="admin-section" style="display: none;">
                    <h1 class="page-title">System Management</h1>
                    <p class="page-subtitle">Execute system configurations and upload necessary features.</p>

                    <div class="dash-card" style="margin-bottom: 30px;">
                        <h3><i class="fa fa-code"></i> JSON Configuration Executor</h3>
                        <p>Execute system updates or configuration changes via JSON input.</p>
                        <textarea id="json-input" class="form-control" rows="8"
                            placeholder='{ "action": "update_config", "params": { ... } }'
                            style="width: 100%; font-family: monospace;"></textarea>
                        <button onclick="executeJson()" class="btn-primary" style="margin-top: 10px;">Execute
                            JSON</button>
                        <div id="json-result" style="margin-top: 10px; font-size: 13px;"></div>
                    </div>

                    <div class="dash-card">
                        <h3><i class="fa fa-upload"></i> Feature Upload</h3>
                        <p>Upload new system features or assets (ZIP/HTML/JS).</p>
                        <input type="file" id="feature-upload" class="form-control" style="margin-bottom: 10px;">
                        <button onclick="uploadFeature()" class="btn-dash">Upload & Install</button>
                        <div id="upload-status" style="margin-top: 10px; font-size: 13px;"></div>
                    </div>
                </div>
        </main>
    </div>

    <script>
        // Admin Dashboard JavaScript
        let currentAdminTab = 'overview';
        let realtimeInterval;

        // Tab switching functionality
        function showAdminTab(tabName) {
            // Hide all sections
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.admin-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected section
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            currentAdminTab = tabName;

            // Load tab-specific data
            loadTabData(tabName);
        }

        // Load data for specific tab
        async function loadTabData(tabName) {
            try {
                switch(tabName) {
                    case 'overview':
                        await loadSystemOverview();
                        break;
                    case 'applications':
                        await loadApplications();
                        break;
                    case 'users':
                        await loadUsers();
                        break;
                    case 'activities':
                        await loadUserActivities();
                        break;
                    case 'notifications':
                        await loadNotifications();
                        break;
                    case 'emails':
                        await loadEmailLogs();
                        break;
                    case 'ads':
                        await loadAds();
                        break;
                    case 'payments':
                        await loadPaymentServices();
                        break;
                }
            } catch (error) {
                console.error(`Error loading ${tabName} data:`, error);
            }
        }

        // Load system overview data
        async function loadSystemOverview() {
            try {
                const response = await fetch('/api/admin/comprehensive-stats');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('totalUsers').textContent = data.stats.totalUsers;
                    document.getElementById('activeUsers').textContent = data.stats.activeUsers;
                    document.getElementById('newUsers').textContent = data.stats.newUsers;
                    document.getElementById('advertisingUsers').textContent = data.stats.advertisingUsers;
                    document.getElementById('totalRevenue').textContent = `$${data.stats.totalRevenue.toFixed(2)}`;
                    document.getElementById('monthlyRevenue').textContent = `$${data.stats.monthlyRevenue.toFixed(2)}`;
                    document.getElementById('pendingCommissions').textContent = `$${data.stats.pendingCommissions.toFixed(2)}`;
                    document.getElementById('totalClicks').textContent = data.stats.totalClicks;
                    document.getElementById('activeCampaigns').textContent = data.stats.activeCampaigns;
                    document.getElementById('pendingApplications').textContent = data.stats.pendingApplications;
                    document.getElementById('adImpressions').textContent = data.stats.adImpressions;
                    document.getElementById('adRevenue').textContent = `$${data.stats.adRevenue.toFixed(2)}`;
                    document.getElementById('systemUptime').textContent = `${data.stats.systemUptime}%`;
                    document.getElementById('activeConnections').textContent = data.stats.activeConnections;
                    document.getElementById('pendingTasks').textContent = data.stats.pendingTasks;
                    document.getElementById('errorRate').textContent = `${data.stats.errorRate}%`;
                }
            } catch (error) {
                console.error('Error loading system overview:', error);
            }
        }

        // Load advertising applications
        async function loadApplications() {
            const applicationsList = document.getElementById('applicationsList');
            applicationsList.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fa fa-spinner fa-spin" style="font-size: 24px;"></i><br>Loading applications...</div>';

            try {
                const response = await fetch('/api/admin/advertising-applications');
                const data = await response.json();

                if (data.success) {
                    let html = '';
                    if (data.applications.length === 0) {
                        html = '<div class="overview-card" style="text-align: center;"><p>No pending applications</p></div>';
                    } else {
                        data.applications.forEach(app => {
                            const socialAccounts = app.social_media_accounts ? Object.entries(app.social_media_accounts).filter(([key, value]) => value).map(([key, value]) => `${key}: ${value}`).join(', ') : 'None';
                            const websites = app.website_urls ? app.website_urls.join(', ') : 'None';

                            html += `
                                <div class="application-card">
                                    <div class="application-header">
                                        <div>
                                            <h4>User: ${app.user_name} (${app.user_email})</h4>
                                            <p><strong>Type:</strong> ${app.application_type} | <strong>Status:</strong> ${app.status}</p>
                                            <p><strong>PayPal:</strong> ${app.paypal_email}</p>
                                        </div>
                                        <div class="application-actions">
                                            <button class="btn-approve" onclick="approveApplication(${app.id}, '${app.user_email}', '${app.application_type}')">
                                                <i class="fa fa-check"></i> Approve
                                            </button>
                                            <button class="btn-reject" onclick="rejectApplication(${app.id}, '${app.user_email}', '${app.application_type}')">
                                                <i class="fa fa-times"></i> Reject
                                            </button>
                                        </div>
                                    </div>
                                    <div style="margin-top: 15px;">
                                        <p><strong>Social Media:</strong> ${socialAccounts}</p>
                                        <p><strong>Websites:</strong> ${websites}</p>
                                        ${app.additional_notes ? `<p><strong>Notes:</strong> ${app.additional_notes}</p>` : ''}
                                        <p style="color: #666; font-size: 12px;">Applied: ${new Date(app.created_at).toLocaleString()}</p>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    applicationsList.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading applications:', error);
                applicationsList.innerHTML = '<div class="overview-card" style="text-align: center; color: #dc3545;"><i class="fa fa-exclamation-triangle"></i> Failed to load applications</div>';
            }
        }

        // Approve advertising application
        async function approveApplication(applicationId, userEmail, applicationType) {
            if (!confirm(`Approve ${applicationType} application for ${userEmail}?`)) return;

            try {
                const response = await fetch('/api/admin/approve-application', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ applicationId, userEmail, applicationType })
                });

                const result = await response.json();
                if (result.success) {
                    showNotification('Application approved successfully! Email sent to user.', 'success');
                    loadApplications(); // Refresh the list
                    loadSystemOverview(); // Update stats
                } else {
                    showNotification(result.message || 'Failed to approve application', 'error');
                }
            } catch (error) {
                console.error('Error approving application:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Reject advertising application
        async function rejectApplication(applicationId, userEmail, applicationType) {
            const reason = prompt('Please provide a reason for rejection:');
            if (!reason) return;

            try {
                const response = await fetch('/api/admin/reject-application', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ applicationId, userEmail, applicationType, reason })
                });

                const result = await response.json();
                if (result.success) {
                    showNotification('Application rejected. Email sent to user.', 'success');
                    loadApplications(); // Refresh the list
                    loadSystemOverview(); // Update stats
                } else {
                    showNotification(result.message || 'Failed to reject application', 'error');
                }
            } catch (error) {
                console.error('Error rejecting application:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Load user management data
        async function loadUsers() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fa fa-spinner fa-spin" style="font-size: 24px;"></i><br>Loading users...</div>';

            try {
                const response = await fetch('/api/admin/users-detailed');
                const data = await response.json();

                if (data.success) {
                    let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
                    html += '<thead><tr style="background: #f8f9fa;">';
                    html += '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee;">Name</th>';
                    html += '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee;">Email</th>';
                    html += '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee;">Role</th>';
                    html += '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee;">Advertising Status</th>';
                    html += '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee;">Commission Balance</th>';
                    html += '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee;">Last Login</th>';
                    html += '<th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee;">Actions</th>';
                    html += '</tr></thead><tbody>';

                    data.users.forEach(user => {
                        const lastLogin = user.last_login ? new Date(user.last_login).toLocaleString() : 'Never';
                        html += `
                            <tr>
                                <td style="padding: 12px; border-bottom: 1px solid #eee;">${user.name}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee;">${user.email}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee;">${user.role}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee;">
                                    <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; background: ${user.advertising_status === 'active' ? '#d4edda' : user.advertising_status === 'pending' ? '#fff3cd' : '#f8f9fa'}; color: ${user.advertising_status === 'active' ? '#155724' : user.advertising_status === 'pending' ? '#856404' : '#666'};">
                                        ${user.advertising_status}
                                    </span>
                                </td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee;">$${user.commission_balance || 0}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee;">${lastLogin}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee;">
                                    <button onclick="viewUserDetails(${user.id})" style="margin-right: 5px;">View</button>
                                    <button onclick="resetUserPassword(${user.id}, '${user.email}')" style="color: #dc3545;">Reset Password</button>
                                </td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table></div>';
                    usersList.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading users:', error);
                usersList.innerHTML = '<div class="overview-card" style="text-align: center; color: #dc3545;"><i class="fa fa-exclamation-triangle"></i> Failed to load users</div>';
            }
        }

        // Load user activities
        async function loadUserActivities() {
            const activitiesBody = document.getElementById('activitiesBody');
            activitiesBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;"><i class="fa fa-spinner fa-spin" style="font-size: 24px;"></i><br>Loading activities...</td></tr>';

            try {
                const response = await fetch('/api/admin/user-activities');
                const data = await response.json();

                if (data.success) {
                    let html = '';
                    if (data.activities.length === 0) {
                        html = '<tr><td colspan="5" style="text-align: center; padding: 40px;">No activities found</td></tr>';
                    } else {
                        data.activities.forEach(activity => {
                            const activityClass = `type-${activity.activity_type.replace('_', '')}`;
                            const timeAgo = new Date(activity.created_at).toLocaleString();
                            html += `
                                <tr>
                                    <td>${activity.user_name || 'Unknown'}</td>
                                    <td><span class="activity-type ${activityClass}">${activity.activity_type.replace('_', ' ')}</span></td>
                                    <td>${JSON.stringify(activity.details).substring(0, 100)}...</td>
                                    <td>${activity.ip_address || 'N/A'}</td>
                                    <td>${timeAgo}</td>
                                </tr>
                            `;
                        });
                    }
                    activitiesBody.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading activities:', error);
                activitiesBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #dc3545;"><i class="fa fa-exclamation-triangle"></i> Failed to load activities</td></tr>';
            }
        }

        // Load notifications
        async function loadNotifications() {
            const notificationsList = document.getElementById('notificationsList');
            notificationsList.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fa fa-spinner fa-spin" style="font-size: 24px;"></i><br>Loading notifications...</div>';

            try {
                const response = await fetch('/api/admin/notifications');
                const data = await response.json();

                if (data.success) {
                    let html = '';
                    if (data.notifications.length === 0) {
                        html = '<div class="overview-card" style="text-align: center;"><p>No notifications</p></div>';
                    } else {
                        data.notifications.forEach(notification => {
                            const priorityClass = notification.priority === 'high' || notification.priority === 'critical' ? `priority-${notification.priority}` : '';
                            const unreadClass = notification.is_read ? '' : 'unread';
                            html += `
                                <div class="notification-item ${unreadClass} ${priorityClass}" onclick="markAsRead(${notification.id})">
                                    <div class="notification-header">
                                        <div class="notification-title">${notification.title}</div>
                                        <div class="notification-time">${new Date(notification.created_at).toLocaleString()}</div>
                                    </div>
                                    <div class="notification-message">${notification.message}</div>
                                </div>
                            `;
                        });
                    }
                    notificationsList.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                notificationsList.innerHTML = '<div class="overview-card" style="text-align: center; color: #dc3545;"><i class="fa fa-exclamation-triangle"></i> Failed to load notifications</div>';
            }
        }

        // Load email logs
        async function loadEmailLogs() {
            const emailsBody = document.getElementById('emailsBody');
            emailsBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;"><i class="fa fa-spinner fa-spin" style="font-size: 24px;"></i><br>Loading email logs...</td></tr>';

            try {
                const response = await fetch('/api/admin/email-logs');
                const data = await response.json();

                if (data.success) {
                    let html = '';
                    if (data.emails.length === 0) {
                        html = '<tr><td colspan="5" style="text-align: center; padding: 40px;">No email logs found</td></tr>';
                    } else {
                        data.emails.forEach(email => {
                            html += `
                                <tr>
                                    <td>${email.recipient_name || email.recipient_email}</td>
                                    <td>${email.subject}</td>
                                    <td>${email.email_type}</td>
                                    <td><span class="email-status status-${email.status}">${email.status}</span></td>
                                    <td>${new Date(email.sent_at).toLocaleString()}</td>
                                </tr>
                            `;
                        });
                    }
                    emailsBody.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading email logs:', error);
                emailsBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #dc3545;"><i class="fa fa-exclamation-triangle"></i> Failed to load email logs</td></tr>';
            }
        }

        // Load ads management
        async function loadAds() {
            const adsList = document.getElementById('adsList');
            adsList.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fa fa-spinner fa-spin" style="font-size: 24px;"></i><br>Loading ads...</div>';

            try {
                const response = await fetch('/api/admin/ads');
                const data = await response.json();

                if (data.success) {
                    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';
                    if (data.ads.length === 0) {
                        html += '<div class="overview-card" style="text-align: center;"><p>No ads created yet</p></div>';
                    } else {
                        data.ads.forEach(ad => {
                            html += `
                                <div class="overview-card">
                                    <h4>${ad.title}</h4>
                                    <p>${ad.content ? ad.content.substring(0, 100) + '...' : 'No content'}</p>
                                    <p><strong>Type:</strong> ${ad.ad_type} | <strong>Priority:</strong> ${ad.display_priority}</p>
                                    <p><strong>Status:</strong> ${ad.is_active ? 'Active' : 'Inactive'}</p>
                                    <p><strong>Impressions:</strong> ${ad.impressions} | <strong>Clicks:</strong> ${ad.clicks}</p>
                                    <div style="margin-top: 10px;">
                                        <button onclick="editAd(${ad.id})" style="margin-right: 5px;">Edit</button>
                                        <button onclick="toggleAd(${ad.id}, ${ad.is_active})" style="margin-right: 5px;">
                                            ${ad.is_active ? 'Deactivate' : 'Activate'}
                                        </button>
                                        <button onclick="deleteAd(${ad.id})" style="color: #dc3545;">Delete</button>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    html += '</div>';
                    adsList.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading ads:', error);
                adsList.innerHTML = '<div class="overview-card" style="text-align: center; color: #dc3545;"><i class="fa fa-exclamation-triangle"></i> Failed to load ads</div>';
            }
        }

        // Load payment services
        async function loadPaymentServices() {
            const paymentsContent = document.getElementById('paymentsContent');
            paymentsContent.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fa fa-spinner fa-spin" style="font-size: 24px;"></i><br>Loading payment services...</div>';

            try {
                // Load both payment services and pending payments summary
                const [servicesResponse, summaryResponse] = await Promise.all([
                    fetch('/api/admin/payment-services'),
                    fetch('/api/admin/pending-payments-summary')
                ]);

                const servicesData = await servicesResponse.json();
                const summaryData = await summaryResponse.json();

                if (servicesData.success && summaryData.success) {
                    let html = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                                <h4>Total Processed</h4>
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">$${servicesData.stats.totalProcessed.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                                <h4>Pending Payments</h4>
                                <div style="font-size: 24px; font-weight: bold; color: #ffc107;">$${servicesData.stats.pendingPayments.toFixed(2)}</div>
                                <div style="font-size: 12px; color: #666;">${summaryData.summary.users_with_pending} users</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                                <h4>System Balance</h4>
                                <div style="font-size: 24px; font-weight: bold; color: #007bff;">$${servicesData.stats.systemBalance.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                                <h4>Pending Commissions</h4>
                                <div style="font-size: 24px; font-weight: bold; color: #dc3545;">${summaryData.summary.total_pending_commissions}</div>
                            </div>
                        </div>
                    `;

                    // Show pending payments breakdown if there are any
                    if (summaryData.breakdown.length > 0) {
                        html += '<h4>Pending Payments Breakdown</h4>';
                        html += '<div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">';
                        html += '<table style="width: 100%; border-collapse: collapse;">';
                        html += '<thead><tr style="background: #f8f9fa;"><th style="padding: 12px; text-align: left;">User</th><th style="padding: 12px; text-align: left;">PayPal Email</th><th style="padding: 12px; text-align: right;">Amount</th><th style="padding: 12px; text-align: center;">Commissions</th></tr></thead><tbody>';

                        summaryData.breakdown.forEach(user => {
                            html += `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 12px;">${user.user_name}<br><small style="color: #666;">${user.user_email}</small></td>
                                    <td style="padding: 12px;">${user.paypal_email}</td>
                                    <td style="padding: 12px; text-align: right; font-weight: bold;">$${user.commission_balance}</td>
                                    <td style="padding: 12px; text-align: center;">${user.pending_commissions}</td>
                                </tr>
                            `;
                        });

                        html += '</tbody></table></div>';
                    }

                    // Action buttons
                    html += `
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <button class="btn-success" onclick="processPendingPayments()" ${summaryData.summary.users_with_pending === 0 ? 'disabled' : ''}>
                                <i class="fa fa-money"></i> Process All Pending Payments
                            </button>
                            <button class="btn-primary" onclick="exportPaymentReport()">
                                <i class="fa fa-download"></i> Export Payment Report
                            </button>
                            <button class="btn-secondary" onclick="configurePayPalSettings()">
                                <i class="fa fa-cog"></i> PayPal Settings
                            </button>
                        </div>
                    `;

                    paymentsContent.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading payment services:', error);
                paymentsContent.innerHTML = '<div class="overview-card" style="text-align: center; color: #dc3545;"><i class="fa fa-exclamation-triangle"></i> Failed to load payment services</div>';
            }
        }

        // Process pending payments
        async function processPendingPayments() {
            if (!confirm('Are you sure you want to process all pending payments? This action cannot be undone.')) return;

            const processBtn = event.target;
            const originalText = processBtn.innerHTML;
            processBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Processing...';
            processBtn.disabled = true;

            try {
                const response = await fetch('/api/admin/process-pending-payments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    showNotification(`Successfully processed $${data.totalAmount.toFixed(2)} in payments for ${data.results.filter(r => r.status === 'processed').length} users!`, 'success');

                    // Refresh the payment services data
                    loadPaymentServices();

                    // Log the action
                    console.log('Payment processing results:', data.results);

                } else {
                    showNotification(data.message || 'Failed to process payments', 'error');
                }

            } catch (error) {
                console.error('Error processing payments:', error);
                showNotification('Network error. Please try again.', 'error');
            } finally {
                processBtn.innerHTML = originalText;
                processBtn.disabled = false;
            }
        }

        // Export payment report (placeholder)
        function exportPaymentReport() {
            showNotification('Payment report export feature coming soon!', 'info');
        }

        // Configure PayPal settings (placeholder)
        function configurePayPalSettings() {
            showNotification('PayPal configuration panel coming soon!', 'info');
        }

        // Mark notification as read
        async function markAsRead(notificationId) {
            try {
                await fetch('/api/admin/mark-notification-read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notificationId })
                });
                loadNotifications(); // Refresh the list
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Utility functions
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                max-width: 400px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            `;

            if (type === 'success') notification.style.backgroundColor = '#28a745';
            else if (type === 'error') notification.style.backgroundColor = '#dc3545';
            else if (type === 'warning') {
                notification.style.backgroundColor = '#ffc107';
                notification.style.color = '#000';
            } else notification.style.backgroundColor = '#007bff';

            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadSystemOverview();

            // Set up real-time updates every 30 seconds
            realtimeInterval = setInterval(() => {
                if (currentAdminTab === 'overview') {
                    loadSystemOverview();
                } else if (currentAdminTab === 'notifications') {
                    loadNotifications();
                }
            }, 30000);
        });
    </script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/admin-dashboard.js"></script>
</body>

</html>